{% extends 'base/dashboard_base.html' %}
{% load static %}

{% block title %}New Loan Application - OptifluenceLMS{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="card-title mb-0">New Loan Application</h4>
                    <a href="{% url 'web_loans:list' %}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-arrow-left me-2"></i>Back to Loans
                    </a>
                </div>
                <div class="card-body">
                    <form method="post" class="needs-validation" novalidate>
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {% for error in form.non_field_errors %}
                            {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
                        
                        <!-- Loan Product Selection -->
                        <div class="mb-3">
                            <label for="{{ form.loan_product.id_for_label }}" class="form-label">Loan Product</label>
                            <select name="{{ form.loan_product.name }}" id="{{ form.loan_product.id_for_label }}" 
                                    class="form-select {% if form.loan_product.errors %}is-invalid{% endif %}" required>
                                <option value="">Select a loan product</option>
                                {% for product in loan_products %}
                                <option value="{{ product.id }}" 
                                        data-min-amount="{{ product.minimum_amount }}"
                                        data-max-amount="{{ product.maximum_amount }}"
                                        data-min-term="{{ product.minimum_term }}"
                                        data-max-term="{{ product.maximum_term }}"
                                        data-interest-rate="{{ product.interest_rate }}"
                                        data-processing-fee="{{ product.processing_fee }}">
                                    {{ product.name }}
                                </option>
                                {% endfor %}
                            </select>
                            {% if form.loan_product.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.loan_product.errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                            <div class="form-text" id="productDetails"></div>
                        </div>
                        
                        <!-- Customer Selection -->
                        <div class="mb-3">
                            <label for="{{ form.customer.id_for_label }}" class="form-label">Customer</label>
                            <select name="{{ form.customer.name }}" id="{{ form.customer.id_for_label }}" 
                                    class="form-select {% if form.customer.errors %}is-invalid{% endif %}" required>
                                <option value="">Select a customer</option>
                                {% for customer in form.customer.field.queryset %}
                                <option value="{{ customer.id }}">{{ customer.get_full_name }}</option>
                                {% endfor %}
                            </select>
                            {% if form.customer.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.customer.errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Loan Amount -->
                        <div class="mb-3">
                            <label for="{{ form.amount.id_for_label }}" class="form-label">Loan Amount</label>
                            <div class="input-group">
                                <span class="input-group-text">KES</span>
                                <input type="number" step="0.01" name="{{ form.amount.name }}" 
                                       id="{{ form.amount.id_for_label }}" 
                                       class="form-control {% if form.amount.errors %}is-invalid{% endif %}"
                                       required>
                            </div>
                            {% if form.amount.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.amount.errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                            <div class="form-text" id="amountRange"></div>
                        </div>

                        <!-- Guarantor Selection (Optional) -->
                        <div class="mb-3">
                            <label for="{{ form.guarantor.id_for_label }}" class="form-label">Guarantor (Optional)</label>
                            <select name="{{ form.guarantor.name }}" id="{{ form.guarantor.id_for_label }}" 
                                    class="form-select {% if form.guarantor.errors %}is-invalid{% endif %}">
                                <option value="">Select a guarantor (optional)</option>
                                {% for customer in customers %}
                                <option value="{{ customer.id }}">{{ customer.get_full_name }}</option>
                                {% endfor %}
                            </select>
                            {% if form.guarantor.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.guarantor.errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                            <div class="form-text">A guarantor can help improve your loan approval chances</div>
                        </div>
                        
                        <!-- Loan Term -->
                        <div class="mb-3">
                            <label for="{{ form.term_months.id_for_label }}" class="form-label">Loan Term (Months)</label>
                            <input type="number" name="{{ form.term_months.name }}" 
                                   id="{{ form.term_months.id_for_label }}" 
                                   class="form-control {% if form.term_months.errors %}is-invalid{% endif %}"
                                   required>
                            {% if form.term_months.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.term_months.errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                            <div class="form-text" id="termRange"></div>
                        </div>
                        
                        <!-- Loan Purpose -->
                        <div class="mb-3">
                            <label for="{{ form.purpose.id_for_label }}" class="form-label">Loan Purpose</label>
                            <textarea name="{{ form.purpose.name }}" 
                                      id="{{ form.purpose.id_for_label }}" 
                                      class="form-control {% if form.purpose.errors %}is-invalid{% endif %}"
                                      rows="3" required></textarea>
                            {% if form.purpose.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.purpose.errors %}
                                {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                Submit Application
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Loan Calculator Card -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Loan Calculator</h5>
                </div>
                <div class="card-body">
                    <div id="loanCalculator">
                        <div class="mb-3">
                            <label class="form-label">Monthly Payment</label>
                            <h3 id="monthlyPayment" class="text-primary">KES 0.00</h3>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Total Payment</label>
                            <h4 id="totalPayment" class="text-secondary">KES 0.00</h4>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Total Interest</label>
                            <h4 id="totalInterest" class="text-info">KES 0.00</h4>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Processing Fee</label>
                            <h4 id="processingFee" class="text-warning">KES 0.00</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const loanProductSelect = document.getElementById('{{ form.loan_product.id_for_label }}');
    const amountInput = document.getElementById('{{ form.amount.id_for_label }}');
    const termInput = document.getElementById('{{ form.term_months.id_for_label }}');
    const productDetails = document.getElementById('productDetails');
    const amountRange = document.getElementById('amountRange');
    const termRange = document.getElementById('termRange');
    
    // Function to format currency
    function formatCurrency(amount) {
        return new Intl.NumberFormat('en-KE', {
            style: 'currency',
            currency: 'KES',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(amount);
    }
    
    // Function to update loan product details
    function updateProductDetails() {
        const selectedOption = loanProductSelect.options[loanProductSelect.selectedIndex];
        if (selectedOption.value) {
            const minAmount = parseFloat(selectedOption.dataset.minAmount);
            const maxAmount = parseFloat(selectedOption.dataset.maxAmount);
            const minTerm = parseInt(selectedOption.dataset.minTerm);
            const maxTerm = parseInt(selectedOption.dataset.maxTerm);
            
            // Update amount input attributes
            amountInput.min = minAmount;
            amountInput.max = maxAmount;
            amountInput.step = 1000;
            
            // Update term input attributes
            termInput.min = minTerm;
            termInput.max = maxTerm;
            
            // Show ranges in the help text
            amountRange.textContent = `Amount Range: ${formatCurrency(minAmount)} - ${formatCurrency(maxAmount)}`;
            termRange.textContent = `Term Range: ${minTerm} - ${maxTerm} months`;
            
            const details = `
                Interest Rate: ${selectedOption.dataset.interestRate}%<br>
                Processing Fee: ${selectedOption.dataset.processingFee}%
            `;
            productDetails.innerHTML = details;
            
            // Trigger calculation
            calculateLoan();
        } else {
            productDetails.innerHTML = '';
            amountRange.textContent = '';
            termRange.textContent = '';
        }
    }
    
    // Function to calculate loan details
    function calculateLoan() {
        const selectedOption = loanProductSelect.options[loanProductSelect.selectedIndex];
        const amount = parseFloat(amountInput.value) || 0;
        const term = parseInt(termInput.value) || 0;
        
        if (selectedOption.value && amount > 0 && term > 0) {
            const interestRate = parseFloat(selectedOption.dataset.interestRate) / 100;
            const monthlyRate = interestRate / 12;
            const processingFeeRate = parseFloat(selectedOption.dataset.processingFee) / 100;
            
            // Calculate monthly payment using the loan amortization formula
            const monthlyPayment = (amount * monthlyRate * Math.pow(1 + monthlyRate, term)) / 
                                 (Math.pow(1 + monthlyRate, term) - 1);
            
            const totalPayment = monthlyPayment * term;
            const totalInterest = totalPayment - amount;
            const processingFeeAmount = amount * processingFeeRate;
            
            // Update calculator display
            document.getElementById('monthlyPayment').textContent = formatCurrency(monthlyPayment);
            document.getElementById('totalPayment').textContent = formatCurrency(totalPayment);
            document.getElementById('totalInterest').textContent = formatCurrency(totalInterest);
            document.getElementById('processingFee').textContent = formatCurrency(processingFeeAmount);
        }
    }
    
    // Event listeners
    loanProductSelect.addEventListener('change', updateProductDetails);
    amountInput.addEventListener('input', calculateLoan);
    termInput.addEventListener('input', calculateLoan);
    
    // Initialize if product is already selected
    if (loanProductSelect.value) {
        updateProductDetails();
    }
});
</script>
{% endblock %}
